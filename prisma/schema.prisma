// This is your Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

// ========================================
// ENUMS
// ========================================

// User roles for role-based access control
enum UserRole {
  OPERATOR    // Can post deliveries/issues, view stock
  SUPERVISOR  // Operator + approve transfers/PRF, manage reconciliations
  ADMIN       // Supervisor + manage items/prices, close periods, system config
}

// Location types
enum LocationType {
  KITCHEN     // Kitchen location
  STORE       // Store location
  CENTRAL     // Central warehouse
  WAREHOUSE   // Other warehouse
}

// User access level per location
enum AccessLevel {
  VIEW        // Read-only access
  POST        // Can post transactions
  MANAGE      // Full management access
}

// Item unit of measure
enum Unit {
  KG          // Kilograms
  EA          // Each
  LTR         // Liters
  BOX         // Box
  CASE        // Case
  PACK        // Pack
}

// Period status for period lifecycle
enum PeriodStatus {
  DRAFT           // Period created but not yet opened
  OPEN            // Period is active for transactions
  PENDING_CLOSE   // Closing initiated, awaiting approval
  APPROVED        // Close approved, ready to execute
  CLOSED          // Period is closed
}

// Period-Location status for coordinated close
enum PeriodLocationStatus {
  OPEN            // Location can post transactions
  READY           // Location ready for period close
  CLOSED          // Location closed for this period
}

// PRF (Purchase Request Form) status
enum PRFStatus {
  DRAFT           // PRF is being created
  PENDING         // Awaiting approval
  APPROVED        // Approved, can create PO
  REJECTED        // Rejected by approver
}

// PO (Purchase Order) status
enum POStatus {
  OPEN            // PO is active
  CLOSED          // PO is closed/completed
}

// Cost centre for issue transactions
enum CostCentre {
  FOOD            // Food cost
  CLEAN           // Cleaning supplies
  OTHER           // Other costs
}

// ========================================
// CORE MODELS (Task 1.2.3)
// ========================================

// User model - System users with role-based access
model User {
  id                  String          @id @default(uuid()) @db.Uuid
  username            String          @unique @db.VarChar(50)
  email               String          @unique @db.VarChar(100)
  full_name           String?         @db.VarChar(100)
  role                UserRole        @default(OPERATOR)
  password_hash       String          @db.VarChar(255) // Added for authentication
  default_location_id String?         @db.Uuid
  is_active           Boolean         @default(true)
  created_at          DateTime        @default(now()) @db.Timestamptz
  last_login          DateTime?       @db.Timestamptz

  // Relations
  default_location    Location?       @relation("UserDefaultLocation", fields: [default_location_id], references: [id], onDelete: SetNull)
  managed_locations   Location[]      @relation("LocationManager")
  user_locations      UserLocation[]
  assigned_users      UserLocation[]  @relation("AssignedBy")
  requested_prfs      PRF[]           @relation("PRFRequester")
  approved_prfs       PRF[]           @relation("PRFApprover")
  posted_deliveries   Delivery[]      @relation("DeliveryPoster")
  posted_issues       Issue[]         @relation("IssuePoster")

  @@map("users")
}

// Location model - Physical sites (Kitchen, Store, Central, Warehouse)
model Location {
  id                String             @id @default(uuid()) @db.Uuid
  code              String             @unique @db.VarChar(10)
  name              String             @db.VarChar(100)
  type              LocationType
  address           String?            @db.Text
  manager_id        String?            @db.Uuid
  timezone          String             @default("Asia/Riyadh") @db.VarChar(50)
  is_active         Boolean            @default(true)
  created_at        DateTime           @default(now()) @db.Timestamptz
  updated_at        DateTime           @updatedAt @db.Timestamptz

  // Relations
  manager           User?              @relation("LocationManager", fields: [manager_id], references: [id], onDelete: SetNull)
  default_for_users User[]             @relation("UserDefaultLocation")
  user_locations    UserLocation[]
  period_locations  PeriodLocation[]
  location_stock    LocationStock[]
  prfs              PRF[]
  deliveries        Delivery[]
  issues            Issue[]

  @@map("locations")
}

// UserLocation model - Join table for user-location access control
model UserLocation {
  user_id       String        @db.Uuid
  location_id   String        @db.Uuid
  access_level  AccessLevel   @default(VIEW)
  assigned_at   DateTime      @default(now()) @db.Timestamptz
  assigned_by   String?       @db.Uuid

  // Relations
  user          User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  location      Location      @relation(fields: [location_id], references: [id], onDelete: Cascade)
  assigner      User?         @relation("AssignedBy", fields: [assigned_by], references: [id], onDelete: SetNull)

  @@id([user_id, location_id])
  @@index([user_id])
  @@index([location_id])
  @@map("user_locations")
}

// Item model - Product master (global across locations)
model Item {
  id            String           @id @default(uuid()) @db.Uuid
  code          String           @unique @db.VarChar(50)
  name          String           @db.VarChar(200)
  unit          Unit
  category      String?          @db.VarChar(50)
  sub_category  String?          @db.VarChar(50)
  is_active     Boolean          @default(true)
  created_at    DateTime         @default(now()) @db.Timestamptz
  updated_at    DateTime         @updatedAt @db.Timestamptz

  // Relations
  item_prices    ItemPrice[]
  location_stock LocationStock[]
  delivery_lines DeliveryLine[]
  issue_lines    IssueLine[]

  @@index([category])
  @@index([is_active])
  @@map("items")
}

// Supplier model - Vendor information
model Supplier {
  id            String        @id @default(uuid()) @db.Uuid
  code          String        @unique @db.VarChar(50)
  name          String        @db.VarChar(200)
  contact       String?       @db.Text
  is_active     Boolean       @default(true)
  created_at    DateTime      @default(now()) @db.Timestamptz

  // Relations
  purchase_orders PO[]
  deliveries      Delivery[]

  @@index([is_active])
  @@map("suppliers")
}

// ========================================
// PERIOD & STOCK MODELS (Task 1.2.4)
// ========================================

// Period model - Monthly accounting periods
model Period {
  id            String              @id @default(uuid()) @db.Uuid
  name          String              @db.VarChar(100) // e.g., "January 2025"
  start_date    DateTime            @db.Date
  end_date      DateTime            @db.Date
  status        PeriodStatus        @default(DRAFT)
  approval_id   String?             @db.Uuid // Reference to Approval model (to be added in 1.2.7)
  created_at    DateTime            @default(now()) @db.Timestamptz
  closed_at     DateTime?           @db.Timestamptz

  // Relations
  period_locations PeriodLocation[]
  item_prices      ItemPrice[]
  prfs             PRF[]
  deliveries       Delivery[]
  issues           Issue[]

  @@index([status])
  @@index([start_date, end_date])
  @@map("periods")
}

// PeriodLocation model - Period status per location for coordinated close
model PeriodLocation {
  period_id      String                @db.Uuid
  location_id    String                @db.Uuid
  status         PeriodLocationStatus  @default(OPEN)
  opening_value  Decimal?              @db.Decimal(15, 2) // Total opening stock value
  closing_value  Decimal?              @db.Decimal(15, 2) // Total closing stock value
  snapshot_id    String?               @db.Uuid // Reference to stock snapshot (JSON stored here or separate table)
  snapshot_data  Json?                 // Stock snapshot at period close
  ready_at       DateTime?             @db.Timestamptz
  closed_at      DateTime?             @db.Timestamptz

  // Relations
  period         Period                @relation(fields: [period_id], references: [id], onDelete: Cascade)
  location       Location              @relation(fields: [location_id], references: [id], onDelete: Cascade)

  @@id([period_id, location_id])
  @@index([period_id])
  @@index([location_id])
  @@index([status])
  @@map("period_locations")
}

// ItemPrice model - Locked prices per period
model ItemPrice {
  id         String    @id @default(uuid()) @db.Uuid
  item_id    String    @db.Uuid
  period_id  String    @db.Uuid
  price      Decimal   @db.Decimal(15, 4) // Unit price
  currency   String    @default("SAR") @db.VarChar(3)
  set_by     String?   @db.Uuid // User who set the price
  set_at     DateTime  @default(now()) @db.Timestamptz

  // Relations
  item       Item      @relation(fields: [item_id], references: [id], onDelete: Cascade)
  period     Period    @relation(fields: [period_id], references: [id], onDelete: Cascade)

  @@unique([item_id, period_id]) // One price per item per period
  @@index([period_id])
  @@index([item_id])
  @@map("item_prices")
}

// LocationStock model - Current stock levels per location
model LocationStock {
  location_id  String    @db.Uuid
  item_id      String    @db.Uuid
  on_hand      Decimal   @default(0) @db.Decimal(15, 4) // Quantity on hand
  wac          Decimal   @default(0) @db.Decimal(15, 4) // Weighted Average Cost
  min_stock    Decimal?  @db.Decimal(15, 4) // Minimum stock level (optional)
  max_stock    Decimal?  @db.Decimal(15, 4) // Maximum stock level (optional)
  last_counted DateTime? @db.Timestamptz     // Last physical count date
  updated_at   DateTime  @updatedAt @db.Timestamptz

  // Relations
  location     Location  @relation(fields: [location_id], references: [id], onDelete: Cascade)
  item         Item      @relation(fields: [item_id], references: [id], onDelete: Cascade)

  @@id([location_id, item_id])
  @@index([location_id])
  @@index([item_id])
  @@index([on_hand]) // For low stock queries
  @@map("location_stock")
}

// ========================================
// TRANSACTION MODELS (Task 1.2.5)
// ========================================

// PRF model - Purchase Request Form
model PRF {
  id            String        @id @default(uuid()) @db.Uuid
  prf_no        String        @unique @db.VarChar(50) // e.g., "PRF-2025-001"
  period_id     String        @db.Uuid
  location_id   String        @db.Uuid
  status        PRFStatus     @default(DRAFT)
  requested_by  String        @db.Uuid // User who requested
  approved_by   String?       @db.Uuid // User who approved/rejected
  request_date  DateTime      @db.Date
  approval_date DateTime?     @db.Date
  notes         String?       @db.Text
  created_at    DateTime      @default(now()) @db.Timestamptz
  updated_at    DateTime      @updatedAt @db.Timestamptz

  // Relations
  period        Period        @relation(fields: [period_id], references: [id], onDelete: Restrict)
  location      Location      @relation(fields: [location_id], references: [id], onDelete: Restrict)
  requester     User          @relation("PRFRequester", fields: [requested_by], references: [id], onDelete: Restrict)
  approver      User?         @relation("PRFApprover", fields: [approved_by], references: [id], onDelete: SetNull)
  purchase_orders PO[]

  @@index([period_id])
  @@index([location_id])
  @@index([status])
  @@index([request_date])
  @@map("prfs")
}

// PO model - Purchase Order
model PO {
  id            String        @id @default(uuid()) @db.Uuid
  po_no         String        @unique @db.VarChar(50) // e.g., "PO-2025-001"
  prf_id        String?       @db.Uuid // Optional link to PRF
  supplier_id   String        @db.Uuid
  status        POStatus      @default(OPEN)
  total_amount  Decimal       @default(0) @db.Decimal(15, 2)
  notes         String?       @db.Text
  created_at    DateTime      @default(now()) @db.Timestamptz
  updated_at    DateTime      @updatedAt @db.Timestamptz

  // Relations
  prf           PRF?          @relation(fields: [prf_id], references: [id], onDelete: SetNull)
  supplier      Supplier      @relation(fields: [supplier_id], references: [id], onDelete: Restrict)
  deliveries    Delivery[]

  @@index([prf_id])
  @@index([supplier_id])
  @@index([status])
  @@map("purchase_orders")
}

// Delivery model - Goods receipt transaction
model Delivery {
  id            String          @id @default(uuid()) @db.Uuid
  delivery_no   String          @unique @db.VarChar(50) // e.g., "DEL-2025-001"
  period_id     String          @db.Uuid
  location_id   String          @db.Uuid
  supplier_id   String          @db.Uuid
  po_id         String?         @db.Uuid // Optional link to PO
  invoice_no    String?         @db.VarChar(100)
  delivery_note String?         @db.Text
  delivery_date DateTime        @db.Date
  total_amount  Decimal         @default(0) @db.Decimal(15, 2)
  has_variance  Boolean         @default(false) // True if any line has price variance
  posted_by     String          @db.Uuid // User who posted
  posted_at     DateTime        @default(now()) @db.Timestamptz

  // Relations
  period        Period          @relation(fields: [period_id], references: [id], onDelete: Restrict)
  location      Location        @relation(fields: [location_id], references: [id], onDelete: Restrict)
  supplier      Supplier        @relation(fields: [supplier_id], references: [id], onDelete: Restrict)
  po            PO?             @relation(fields: [po_id], references: [id], onDelete: SetNull)
  poster        User            @relation("DeliveryPoster", fields: [posted_by], references: [id], onDelete: Restrict)
  delivery_lines DeliveryLine[]

  @@index([period_id])
  @@index([location_id])
  @@index([supplier_id])
  @@index([po_id])
  @@index([delivery_date])
  @@index([has_variance]) // For price variance queries
  @@map("deliveries")
}

// DeliveryLine model - Line items in delivery
model DeliveryLine {
  id             String      @id @default(uuid()) @db.Uuid
  delivery_id    String      @db.Uuid
  item_id        String      @db.Uuid
  quantity       Decimal     @db.Decimal(15, 4)
  unit_price     Decimal     @db.Decimal(15, 4) // Actual price from delivery
  period_price   Decimal     @db.Decimal(15, 4) // Expected price from period
  price_variance Decimal     @default(0) @db.Decimal(15, 4) // unit_price - period_price
  line_value     Decimal     @db.Decimal(15, 2) // quantity × unit_price
  ncr_id         String?     @db.Uuid // Link to auto-generated NCR (to be added in 1.2.7)

  // Relations
  delivery       Delivery    @relation(fields: [delivery_id], references: [id], onDelete: Cascade)
  item           Item        @relation(fields: [item_id], references: [id], onDelete: Restrict)

  @@index([delivery_id])
  @@index([item_id])
  @@index([ncr_id])
  @@map("delivery_lines")
}

// Issue model - Stock issue transaction
model Issue {
  id            String        @id @default(uuid()) @db.Uuid
  issue_no      String        @unique @db.VarChar(50) // e.g., "ISS-2025-001"
  period_id     String        @db.Uuid
  location_id   String        @db.Uuid
  issue_date    DateTime      @db.Date
  cost_centre   CostCentre    @default(FOOD)
  total_value   Decimal       @default(0) @db.Decimal(15, 2)
  notes         String?       @db.Text
  posted_by     String        @db.Uuid // User who posted
  posted_at     DateTime      @default(now()) @db.Timestamptz

  // Relations
  period        Period        @relation(fields: [period_id], references: [id], onDelete: Restrict)
  location      Location      @relation(fields: [location_id], references: [id], onDelete: Restrict)
  poster        User          @relation("IssuePoster", fields: [posted_by], references: [id], onDelete: Restrict)
  issue_lines   IssueLine[]

  @@index([period_id])
  @@index([location_id])
  @@index([issue_date])
  @@index([cost_centre])
  @@map("issues")
}

// IssueLine model - Line items in issue
model IssueLine {
  id            String      @id @default(uuid()) @db.Uuid
  issue_id      String      @db.Uuid
  item_id       String      @db.Uuid
  quantity      Decimal     @db.Decimal(15, 4)
  wac_at_issue  Decimal     @db.Decimal(15, 4) // WAC at time of issue (not recalculated)
  line_value    Decimal     @db.Decimal(15, 2) // quantity × wac_at_issue

  // Relations
  issue         Issue       @relation(fields: [issue_id], references: [id], onDelete: Cascade)
  item          Item        @relation(fields: [item_id], references: [id], onDelete: Restrict)

  @@index([issue_id])
  @@index([item_id])
  @@map("issue_lines")
}
