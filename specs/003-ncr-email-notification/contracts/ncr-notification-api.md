# API Contract: NCR Notification Service

**Feature**: 003-ncr-email-notification
**Module**: Server utility (not a REST endpoint)

---

## Overview

The NCR notification service is an internal server utility, not a public API endpoint. It is triggered automatically when NCRs are created via:

1. Manual NCR creation: `POST /api/ncrs`
2. Auto-generated NCR: Price variance detection during delivery posting

---

## Service Interface

### sendNCRCreatedNotification

Sends email notifications to all configured recipient groups when an NCR is created.

**Location**: `server/utils/email.ts`

```typescript
/**
 * Send NCR creation notification to all configured recipients
 *
 * @param params - NCR notification parameters
 * @returns Promise with results for each recipient group
 */
export async function sendNCRCreatedNotification(
  params: NCRNotificationParams
): Promise<NCRNotificationResult>;
```

---

## Types

### NCRNotificationParams

```typescript
interface NCRNotificationParams {
  // NCR details
  ncrId: string;
  ncrNo: string;
  ncrType: "MANUAL" | "PRICE_VARIANCE";
  autoGenerated: boolean;

  // Location
  locationName: string;

  // Content
  reason: string;
  value: string; // Formatted with currency (e.g., "SAR 1,234.56")
  createdAt: string; // ISO date string

  // Item details (for PRICE_VARIANCE)
  itemName?: string;
  itemCode?: string;
  quantity?: number;
  expectedPrice?: string; // Formatted with currency
  actualPrice?: string; // Formatted with currency
  varianceAmount?: string; // Formatted with currency
  variancePercent?: string; // Formatted percentage (e.g., "+5.2%")

  // Delivery reference (if linked)
  deliveryNo?: string;
  supplierName?: string;

  // Recipients
  financeTeamEmails: string[];
  procurementTeamEmails: string[];
  supplierEmails: string[];

  // System URLs
  ncrUrl: string; // Link to view NCR in system
}
```

### NCRNotificationResult

```typescript
interface NCRNotificationResult {
  success: boolean;
  results: {
    finance: EmailResult;
    procurement: EmailResult;
    supplier: EmailResult;
  };
  logs: NCRNotificationLog[]; // Notification log entries created
}

interface EmailResult {
  success: boolean;
  messageId?: string;
  error?: string;
  skipped?: boolean; // True if no recipients configured
}
```

---

## Email Templates

### Internal Team Email (Finance/Procurement)

**Subject**: `NCR Created: ${ncrNo} - ${ncrType === "PRICE_VARIANCE" ? "Price Variance" : "Manual NCR"}`

**Content Structure**:

```html
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
  <h2 style="color: #dc2626;">NCR Created</h2>
  <p>A new Non-Conformance Report has been created and requires attention.</p>

  <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
    <tr>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
        <strong>NCR Number:</strong>
      </td>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${ncrNo}</td>
    </tr>
    <tr>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;"><strong>Type:</strong></td>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${ncrType}</td>
    </tr>
    <tr>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;"><strong>Location:</strong></td>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${locationName}</td>
    </tr>
    <tr>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;"><strong>Value:</strong></td>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${value}</td>
    </tr>
    <tr>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;"><strong>Reason:</strong></td>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${reason}</td>
    </tr>
    <!-- If delivery linked -->
    <tr>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;"><strong>Delivery:</strong></td>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${deliveryNo}</td>
    </tr>
    <tr>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;"><strong>Supplier:</strong></td>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${supplierName}</td>
    </tr>
  </table>

  <!-- If PRICE_VARIANCE -->
  <h3 style="color: #374151; margin-top: 20px;">Price Variance Details</h3>
  <table style="width: 100%; border-collapse: collapse; margin: 10px 0; border: 1px solid #e5e7eb;">
    <tr style="background-color: #fef2f2;">
      <td style="padding: 8px;"><strong>Item:</strong></td>
      <td style="padding: 8px;">${itemCode} - ${itemName}</td>
    </tr>
    <tr>
      <td style="padding: 8px;"><strong>Quantity:</strong></td>
      <td style="padding: 8px;">${quantity}</td>
    </tr>
    <tr>
      <td style="padding: 8px;"><strong>Expected Price:</strong></td>
      <td style="padding: 8px;">${expectedPrice}</td>
    </tr>
    <tr>
      <td style="padding: 8px;"><strong>Actual Price:</strong></td>
      <td style="padding: 8px;">${actualPrice}</td>
    </tr>
    <tr style="background-color: #fef2f2;">
      <td style="padding: 8px;"><strong>Variance:</strong></td>
      <td style="padding: 8px; color: #dc2626; font-weight: bold;">
        ${varianceAmount} (${variancePercent})
      </td>
    </tr>
  </table>

  <p style="margin-top: 20px;">
    <a
      href="${ncrUrl}"
      style="display: inline-block; padding: 12px 24px; background-color: #dc2626; color: white; text-decoration: none; border-radius: 6px;"
    >
      View NCR Details
    </a>
  </p>

  <p style="color: #6b7280; font-size: 14px; margin-top: 30px;">
    This is an automated notification from the Stock Management System.
  </p>
</div>
```

---

### Supplier Email

**Subject**: `Non-Conformance Report: ${ncrNo} - ${companyName}`

**Content Structure** (different from internal):

```html
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
  <h2 style="color: #dc2626;">Non-Conformance Report</h2>
  <p>Dear ${supplierName},</p>
  <p>
    We are writing to inform you that a Non-Conformance Report has been raised regarding a recent
    delivery.
  </p>

  <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
    <tr>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
        <strong>NCR Reference:</strong>
      </td>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${ncrNo}</td>
    </tr>
    <tr>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;"><strong>Date:</strong></td>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${createdAt}</td>
    </tr>
    <tr>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
        <strong>Delivery Reference:</strong>
      </td>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${deliveryNo}</td>
    </tr>
    <tr>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;"><strong>Issue:</strong></td>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${reason}</td>
    </tr>
    <tr>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;"><strong>Value:</strong></td>
      <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">${value}</td>
    </tr>
  </table>

  <!-- If PRICE_VARIANCE -->
  <h3 style="color: #374151; margin-top: 20px;">Details</h3>
  <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
    <tr>
      <td style="padding: 8px 0;"><strong>Item:</strong></td>
      <td style="padding: 8px 0;">${itemCode} - ${itemName}</td>
    </tr>
    <tr>
      <td style="padding: 8px 0;"><strong>Quantity:</strong></td>
      <td style="padding: 8px 0;">${quantity}</td>
    </tr>
    <tr>
      <td style="padding: 8px 0;"><strong>Expected Unit Price:</strong></td>
      <td style="padding: 8px 0;">${expectedPrice}</td>
    </tr>
    <tr>
      <td style="padding: 8px 0;"><strong>Invoiced Unit Price:</strong></td>
      <td style="padding: 8px 0;">${actualPrice}</td>
    </tr>
  </table>

  <h3 style="color: #374151; margin-top: 20px;">Next Steps</h3>
  <p>Please review this Non-Conformance Report and respond with one of the following:</p>
  <ol>
    <li>
      <strong>Credit Note:</strong>
      Issue a credit note for the variance amount
    </li>
    <li>
      <strong>Explanation:</strong>
      Provide documentation supporting the price difference
    </li>
  </ol>

  <p>Please reply to this email with your response or contact our procurement team directly.</p>

  <p style="color: #6b7280; font-size: 14px; margin-top: 30px;">
    Best regards,
    <br />
    ${companyName}
  </p>
</div>
```

---

## Integration Points

### Manual NCR Creation

**File**: `server/api/ncrs/index.post.ts`

```typescript
// After NCR creation
const ncr = await prisma.nCR.create({ ... });

// Trigger notification asynchronously
void triggerNCRNotification(ncr.id).catch((err) => {
  console.error("[NCR Notification] Failed to send:", err);
});

return { message: "NCR created successfully", ncr };
```

### Auto-Generated NCR (Price Variance)

**File**: `server/utils/priceVariance.ts`

```typescript
// After creating price variance NCR
const ncr = await prisma.nCR.create({
  data: {
    type: "PRICE_VARIANCE",
    auto_generated: true,
    // ... other fields
  },
});

// Trigger notification asynchronously
void triggerNCRNotification(ncr.id).catch((err) => {
  console.error("[NCR Notification] Failed to send:", err);
});
```

---

## Notification Logging

Each notification attempt creates a log entry in `NCRNotificationLog`:

```typescript
// For each recipient group
await prisma.nCRNotificationLog.create({
  data: {
    ncr_id: ncrId,
    recipient_type: "FINANCE", // or "PROCUREMENT" or "SUPPLIER"
    recipients: emails,
    status: result.success ? "SENT" : "FAILED",
    error_message: result.error || null,
  },
});
```

---

## Error Handling

| Scenario                 | Behavior                                  |
| ------------------------ | ----------------------------------------- |
| No recipients configured | Skip group, log with `skipped: true`      |
| SMTP not configured      | Log to console, return success (dev mode) |
| SMTP connection failed   | Log error, continue with other groups     |
| Invalid email in list    | Attempt send anyway (SMTP will bounce)    |
| NCR not found            | Log error, return failure                 |

---

## Environment Variables

Required for email delivery:

- `SMTP_USER` - SMTP username
- `SMTP_PASSWORD` - SMTP password
- `SMTP_HOST` - SMTP server (default: smtp.office365.com)
- `SMTP_PORT` - SMTP port (default: 587)
- `EMAIL_FROM` - From address (default: SMTP_USER)
- `NUXT_PUBLIC_SITE_URL` - Base URL for NCR links
